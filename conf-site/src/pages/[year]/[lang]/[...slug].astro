---
import { getCollection } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import ImportantDates from "../../../components/ImportantDates.astro";
import Sponsors from "../../../components/Sponsors.astro";
import NoticeBoard from "../../../components/NoticeBoard.astro";
import CommitteeGrid from "../../../components/CommitteeGrid.astro";
import KeynoteCards from "../../../components/KeynoteCards.astro";
import ProgramSchedule from "../../../components/ProgramSchedule.astro";

export async function getStaticPaths() {
  const conferences = await getCollection("conference");
  const enConferences = conferences.filter((conf) => conf.data.lang === "en");
  const paths = [];

  for (const conf of enConferences) {
    const year = String(conf.data.year);
    const lang = String(conf.data.lang);
    const pages = conf.data.pages || {};

    for (const [slug, pageData] of Object.entries(pages)) {
      if (!slug) continue;
      paths.push({
        params: { year, lang, slug: String(slug) }, // Astro supports string with slashes for rest params too, but let's be safe
        props: { data: conf.data, pageData, slug },
      });
    }
  }
  return paths;
}

import { marked } from "marked";
import type { MenuItem } from "../../../config/menu";

const { data, pageData, slug } = Astro.props;
const {
  year,
  lang,
  meta,
  menu,
  importantDates,
  partners = [],
  notice = [],
  committee = [],
  programSchedule = [],
  workshopSchedules = {},
  keynotes = [],
  footer,
} = data;

const toKey = (segment: string) => segment.replace(/-/g, "_");
const findOrCreate = (
  items: MenuItem[],
  href: string,
  key: string,
  label: string,
) => {
  let found = items.find((item) => item.href === href);
  if (!found) {
    found = { key, href, label };
    items.push(found);
  } else if (!found.label) {
    found.label = label;
  }
  return found;
};

const buildMenuItems = (pages: Record<string, { title: string }>) => {
  const items: MenuItem[] = [
    { key: "home", href: "", label: menu.home || "Home" },
  ];
  if (!pages) return items;

  Object.keys(pages).forEach((path) => {
    if (!path) return;
    const segments = path.split("/");
    let current = items;
    segments.forEach((segment, index) => {
      const href = segments.slice(0, index + 1).join("/");
      const key = toKey(segment);
      const label = menu[key] || pages[href]?.title || key;
      const node = findOrCreate(current, href, key, label);
      if (index === segments.length - 1) return;
      if (!node.children) node.children = [];
      current = node.children;
    });
  });

  return items;
};

const menuItems = buildMenuItems(data.pages || {});

// Check if this is the committee page
const isCommitteePage = slug === "committee";
const isKeynotePage = slug === "keynote";
const isProgramPage = slug === "program";
const isNoticePage = slug === "notice";
const isCallForPapersPage = slug.startsWith("call-for-papers");
const workshopScheduleForPage =
  workshopSchedules && slug ? workshopSchedules[slug] : [];

// Find the current main menu section for the sidebar
const currentSection = menuItems.find(
  (item) =>
    item.href === slug ||
    (item.children &&
      item.children.some(
        (child) =>
          child.href === slug ||
          (child.children && child.children.some((sub) => sub.href === slug)),
      )),
);

const sidebarTitle =
  (menu && currentSection && menu[currentSection.key]) || "Menu";
const sidebarItems = currentSection?.children || [];

const base = import.meta.env.BASE_URL;
const addTrailingSlash = (path: string) => {
  if (!path) return path;
  if (path.endsWith("/")) return path;
  if (/\.[a-zA-Z0-9]+$/.test(path)) return path;
  return `${path}/`;
};

const getUrl = (path: string) => {
  const cleanPath = path.startsWith("/") ? path.slice(1) : path;
  const normalizedBase = base.endsWith("/") ? base : base + "/";
  const finalPath = addTrailingSlash(cleanPath);
  return `${normalizedBase}${finalPath}`;
};

// Convert Markdown to HTML with base-aware asset URLs
const renderer = new marked.Renderer();
renderer.image = (href, title, text) => {
  if (!href) return "";
  const rawHref = typeof href === "string" ? href : href?.href;
  if (!rawHref) return "";
  const src = rawHref.startsWith("http") ? rawHref : getUrl(rawHref);
  const titleAttr = title ? ` title="${title}"` : "";
  const altAttr = text ? text : "";
  return `<img src="${src}" alt="${altAttr}"${titleAttr} />`;
};

const contentHtml = await marked.parse(pageData.content || "", { renderer });
---

<Layout
  title={`${pageData.title} - ${meta.title}`}
  lang={lang}
  year={year}
  menuLabels={menu}
>
  <!-- Subpage Header (ICUFN Style) -->
  <section class="bg-[#1a3050] text-white py-8 md:py-12 relative overflow-hidden">
    <div class="absolute inset-0 opacity-10">
      <div
        class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"
      >
      </div>
    </div>
    <div
      class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 text-center lg:text-left"
    >
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight uppercase">
        {pageData.title}
      </h1>
      <div
        class="flex items-center justify-center lg:justify-start gap-2 text-blue-200 mt-4 text-sm font-medium"
      >
        <a
          href={getUrl(`${year}/${lang}`)}
          class="hover:text-white transition-colors">HOME</a
        >
        <span>/</span>
        <span class="text-white uppercase">{pageData.title}</span>
      </div>
    </div>
  </section>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-12">
      <!-- Sidebar Navigation (Desktop only) -->
      <aside class="hidden lg:block lg:col-span-1">
        <div class="sticky top-24 flex flex-col gap-8 min-h-[60vh]">
          <div
            class="bg-gray-50 rounded-xl border border-gray-200 overflow-hidden shadow-sm"
          >
            <div class="bg-[#003366] px-6 py-4">
              <h2 class="text-lg font-bold text-white uppercase tracking-wider">
                {sidebarTitle}
              </h2>
            </div>
            <nav class="py-2">
              {
                sidebarItems.length > 0 ? (
                  sidebarItems.map((item) => (
                    <div class="px-2">
                      <a
                        href={getUrl(`${year}/${lang}/${item.href}`)}
                        class={`block px-4 py-3 rounded-lg text-sm font-bold uppercase transition-all ${slug === item.href ? "bg-blue-600 text-white shadow-md transform translate-x-1" : "text-gray-600 hover:bg-blue-50 hover:text-blue-700"}`}
                      >
                        {item.label || (menu && menu[item.key]) || item.key}
                      </a>
                      {item.children && slug.startsWith(item.href) && (
                        <div class="pl-6 mt-1 space-y-1 pb-2">
                          {item.children.map((sub) => (
                            <a
                              href={getUrl(`${year}/${lang}/${sub.href}`)}
                              class={`block px-4 py-2 rounded-md text-xs font-bold uppercase transition-colors ${slug === sub.href ? "text-blue-700 bg-blue-50" : "text-gray-500 hover:text-blue-600"}`}
                            >
                              - {sub.label || (menu && menu[sub.key]) || sub.key}
                            </a>
                          ))}
                        </div>
                      )}
                    </div>
                  ))
                ) : null
              }
            </nav>
          </div>

          {!isCallForPapersPage && (
            <ImportantDates dates={importantDates} title="Important Dates" />
          )}

          <div class="mt-auto">
            <Sponsors partners={partners} />
          </div>
        </div>
      </aside>

      <!-- Main Content Area -->
      <div class="lg:col-span-3">
        <div
          class="bg-white p-6 md:p-10 rounded-2xl shadow-xl border border-gray-100 min-h-[600px]"
        >
          <!-- Post Header Meta -->
          <div
            class="flex justify-between items-center mb-8 border-b border-gray-100 pb-4"
          >
            <h2
              class="text-2xl font-bold text-[#1a3050] border-l-4 border-blue-600 pl-4"
            >
              {pageData.title}
            </h2>
            <button
              onclick="window.history.back()"
              class="text-xs font-bold text-gray-400 hover:text-blue-600 flex items-center gap-1 uppercase tracking-widest transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg
              >
              Back to List
            </button>
          </div>

          {isNoticePage ? (
            notice && notice.length > 0 ? (
              <NoticeBoard
                notices={notice}
                title="News & Notice"
                showContent={true}
              />
            ) : null
          ) : (
            <div class="prose max-w-none prose-slate">
              <Fragment set:html={contentHtml} />
            </div>
          )}

          {
            isCommitteePage && committee && committee.length > 0 && (
              <div class="mt-12">
                <CommitteeGrid members={committee} />
              </div>
            )
          }

          {
            isKeynotePage && keynotes && keynotes.length > 0 && (
              <div class="mt-12">
                <KeynoteCards items={keynotes} />
              </div>
            )
          }

          {
            isProgramPage && programSchedule && programSchedule.length > 0 && (
              <div class="mt-12">
                <ProgramSchedule days={programSchedule} />
              </div>
            )
          }

          {
            workshopScheduleForPage &&
              workshopScheduleForPage.length > 0 && (
                <div class="mt-12">
                  <ProgramSchedule
                    days={workshopScheduleForPage}
                    title="Workshop Schedule"
                  />
                </div>
              )
          }
        </div>
      </div>
    </div>
  </div>

  <div slot="footer-content">
    <p class="mb-2 font-medium">{footer.copyright}</p>
    <p class="text-sm text-gray-500">{footer.contact}</p>
  </div>
</Layout>
